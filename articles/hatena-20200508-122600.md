---
title: "GCPã®Deep Learning VMã‚’Preemptibleã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ä½¿ã†æ–¹æ³•"
emoji: "ğŸ˜€"
type: "tech"
topics: [GCP]
published: true
---
GCPã®Marketplaceã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹Deep Learning VMã¯ã€æ·±å±¤å­¦ç¿’ã‚’GPUã§è¡Œã†ãŸã‚ã«å¿…è¦ãªãƒ‰ãƒ©ã‚¤ãƒã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãªã©ã®é¢å€’ãªç’°å¢ƒæ§‹ç¯‰ã‚’è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚
ãŸã ã€GCP Consoleã‹ã‚‰ã ã¨Preemptibleã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã§ããªã„ã‚ˆã†ãªã®ã§ã€gcloudã«ã‚ˆã‚‹ä½œæˆæ‰‹é †ã‚’è¨˜éŒ²ã—ã¦ãŠãã¾ã™ã€‚
â€‹
### Preemptibleã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã¯ï¼Ÿ
â€‹
VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä¸€ç¨®ã€‚ç‰¹å¾´ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚
â€‹

* Pros
  * é€šå¸¸ã‚ˆã‚Šä½ä¾¡æ ¼ã§ä½¿ç”¨ã§ãã‚‹ï¼ˆæœ€å¤§ç´„80%ã‚ªãƒ•ï¼‰
* Cons
  * ä»–ã®ã‚¿ã‚¹ã‚¯ã§ãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã¨ãªã£ãŸå ´åˆã€GCEã«ã‚ˆã£ã¦åœæ­¢ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
  * ä»–ã®ã‚¿ã‚¹ã‚¯ã§ãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ã¨ãªã‚‰ãªãã¦ã‚‚ã€24æ™‚é–“å¾Œã«åœæ­¢ã•ã‚Œã‚‹
  * é€šå¸¸ã®VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ©ã‚¤ãƒ–ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ããªã„
  * ä½™å‰°ãƒªã‚½ãƒ¼ã‚¹ãŒãªã„å ´åˆã¯ä½¿ãˆãªã„
  * SLAï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ«å¥‘ç´„ï¼‰ã®å¯¾è±¡å¤–
â€‹

### ä½œæˆæ‰‹é †
â€‹
`gcloud compute instances create` ã‚³ãƒãƒ³ãƒ‰ã‚’ç”¨ã„ã‚‹ã€‚
é€šå¸¸ã®VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•æ™‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«åŠ ãˆã¦ã€ä»¥ä¸‹ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã™ã‚Œã°ã‚ˆã„ã€‚
â€‹

* `--preemptible`
  * ãƒ—ãƒªã‚¨ãƒ³ãƒ—ãƒ†ã‚£ãƒ–ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒ‡å®š
* `--image-project=deeplearning-platform-release`
  * Deep Learning VMã‚’æŒ‡å®š
* `--accelerator="type=accelerator-type,count=accelerator-count"`
  * accelerator-type: GPUã®ç¨®é¡
  * accelerator-count: GPUã®æ•°
  * ã‚¾ãƒ¼ãƒ³ã«ã‚ˆã£ã¦ä½¿ãˆã‚‹GPUãŒç•°ãªã‚‹ãŸã‚æ³¨æ„
  * è©³ã—ãã¯[ã“ã¡ã‚‰](https://cloud.google.com/compute/docs/gpus/add-gpus)
* `--metadata="install-nvidia-driver=True"`
  * NVIDIAã®ãƒ‰ãƒ©ã‚¤ãƒã‚’è‡ªå‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹â€‹


å®Ÿè¡Œä¾‹ã¯ä»¥ä¸‹ã€‚
â€‹
```sh
export IMAGE_FAMILY="tf2-latest-gpu"
export ZONE="us-central1-b"
export INSTANCE_NAME="deap-learning-vm"
export BOOT_DISC_SIZE="100GB"
export MACHINE_TYPE="n1-highmem-2"

gcloud compute instances create $INSTANCE_NAME \
  --zone=$ZONE \
  --image-family=$IMAGE_FAMILY \
  --image-project=deeplearning-platform-release \
  --maintenance-policy=TERMINATE \
  --accelerator="type=nvidia-tesla-t4,count=1" \
  --metadata="install-nvidia-driver=True" \
  --boot-disk-type="pd-standard" \
  --boot-disk-size=$BOOT_DISC_SIZE \
  --machine-type=$MACHINE_TYPE \
  --preemptible
```
â€‹
### Notebookã®ä½¿ç”¨æ–¹æ³•
â€‹
ã“ã®æ‰‹é †ã§VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹ã¨ã€Jupyter LabãŒè‡ªå‹•ã§ç«‹ã¡ä¸ŠãŒã‚‹ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒ `your-project-id` ã®å ´åˆã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã§å®Ÿè¡Œã™ã‚‹ã¨ã€`http://localhost:8080` ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°Jupyter LabãŒä½¿ãˆã‚‹ã€‚
â€‹
```sh
export PROJECT_ID="your-project-id"
export ZONE="us-central1-b"
export INSTANCE_NAME="deap-learning-vm"
gcloud compute ssh --project $PROJECT_ID --zone $ZONE \
  $INSTANCE_NAME -- -L 8080:localhost:8080
```
â€‹
### Referencesâ€‹

1. [Quickstart: Creating a New Instance Using the Command Line](https://cloud.google.com/ai-platform/deep-learning-vm/docs/quickstart-cli)
1. [Adding or removing GPUs](https://cloud.google.com/compute/docs/gpus/add-gpus)
1. [gcloud compute instances create](https://cloud.google.com/sdk/gcloud/reference/compute/instances/create)
1. [Connecting to JupyterLab](https://cloud.google.com/ai-platform/deep-learning-vm/docs/jupyter)
