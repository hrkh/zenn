---
title: "Hiveã«æ–‡å­—åˆ—ã§æ ¼ç´ã•ã‚ŒãŸJSONå½¢å¼ã®é…åˆ—ã‚’è¡Œã¨ã—ã¦å±•é–‹ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ˜€"
type: "tech"
topics: [Hive]
published: true
---
ã‚¿ã‚¤ãƒˆãƒ«ã ã‘ã ã¨ä½•ã‚’è¨€ã£ã¦ã„ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚‰ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ä¸‹ã®ä¾‹ã‚’è¦‹ã¦ã„ãŸã ã‘ã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã‹ã¨æ€ã„ã¾ã™ã€‚

### çŠ¶æ³

Hiveã«å…¥ã£ã¦ã„ã‚‹ã®ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆitemsï¼‰ã§ã€idã¯intã€nameã¨attrã¯stringã€‚

|id|name|attr|
|-|-|-|
|1|aaa|[{"key": "age", "value": 20}, {"key": "gender", "value": 1}, {"key": "location", "value": 12}]|
|2|bbb| {"key": "age", "value": 30}, {"key": "gender", "value": 2} |

å®Ÿéš›ã«æ¬²ã—ã„ã®ã¯ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ã€‚

|id|name|key|value|
|-|-|-|-|
|1|aaa|age|20|
|1|aaa|gender|1|
|1|aaa|location|12|
|2|bbb|age|30|
|2|bbb|gender|2|

attrã¯stringï¼ˆå¤§äº‹ãªã“ã¨ãªã®ã§å†ç¢ºèªï¼‰ã€‚
ã‚‚ã—ã“ã‚ŒãŒarrayã¨ã‹ã§ã‚ã‚Œã°ã‚‚ã†å°‘ã—ç°¡å˜ã ã£ãŸã¯ãšã€‚

### å®Ÿéš›ã«æ›¸ã„ãŸã‚¯ã‚¨ãƒª

```sql
select
  id,
  name,
  key,
  value
from
  items
lateral view
  explode(
    split(
      substr(attr, 2, length(attr) - 2),
      '(?<=}),\s*'
    )
  ) exploded as json
lateral view
  json_tuple(
    json,
    'key',
    'value'
  ) extracted as key, value
```

### è§£èª¬

```sql
lateral view
  explode(
    split(
      substr(attr, 2, len(attr) - 2),
      '(?<=}),\s*'
    )
  ) exploded as json
```

ã¾ãšã€attrã®2æ–‡å­—ç›®ã‹ã‚‰ï¼ˆæ–‡å­—æ•° - 2ï¼‰æ–‡å­—åˆ†ã¾ã§ã‚’å–ã‚Šå‡ºã™ã“ã¨ã§ã€ä¸¡ç«¯ã®`[`ã¨`]`ã‚’å–ã‚Šé™¤ãã€‚

æ¬¡ã«ã€splitã§é…åˆ—åŒ–ã™ã‚‹ã€‚ã“ã®ã¨ãã€å˜ç´”ã«`,`ã§åŒºåˆ‡ã£ã¦ã—ã¾ã†ã¨ã€JSONã®ä¸­èº«ã®ã‚«ãƒ³ãƒã‚’æ‹¾ã£ã¦ã—ã¾ã£ãŸã‚Šã€ä½™è¨ˆãªç©ºç™½ãŒæ®‹ã£ã¦ã—ã¾ã£ãŸã‚Šã™ã‚‹ã®ã§ã€æ­£è¦è¡¨ç¾ã§åŒºåˆ‡ã‚Šã‚’æŒ‡å®šã™ã‚‹ã€‚

ãã—ã¦ã€explodeã§é…åˆ—ã®è¦ç´ ï¼ˆJSONï¼‰ã‚’è¡Œã¨ã—ã¦å±•é–‹ã—ã€lateral viewã§æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨ªã«é…ç½®ã™ã‚‹ã€‚

```sql
lateral view
  json_tuple(
    json,
    'key',
    'value'
  ) extracted as key, value
```

ã•ã‚‰ã«ã€ä¸Šã§å±•é–‹ã—ãŸJSONã‹ã‚‰json_tupleã§keyã¨valueã¨å–ã‚Šå‡ºã—ã€lateral viewã§æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¨ªã«é…ç½®ã™ã‚‹

å¾Œã¯æ™®é€šã«selectã™ã‚Œã°OKã€‚

### ã¾ã¨ã‚

å‡¦ç†ã«ã¨ã¦ã‚‚æ‚©ã‚“ã ã®ã§ãƒ¡ãƒ¢ã€‚
ã“ã‚“ãªãƒ‡ãƒ¼ã‚¿ã®æŒã¡æ–¹ã—ã¦ã„ã‚‹äº‹ä¾‹ãŒä»–ã«ã‚ã‚‹ã‹ã¨è¨€ã‚ã‚Œã‚‹ã¨å¾®å¦™ãªæ°—ã‚‚ã—ã¾ã™ãŒã€‚
